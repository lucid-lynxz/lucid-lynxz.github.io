<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>VideoView.md | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="项目需要做一个简单的播放视频功能demo,后期会换成公司自己的组件,所以就没考虑使用第三方库了,直接上系统的VideoView,在这里记录下操作;顺便吐槽下:一直都听说简书编辑器好用,第一次使用,有点失望,markdown跟效果分栏竟然不能同步滚动,也不支持[TOC],没有个目录实在很不习惯,表情图标也不能插入,代码区块加空行经常都识别不了啊,就不能让我简单滴从笔记中直接粘贴md文本吗… &#x3D;&#x3D;!">
<meta property="og:type" content="article">
<meta property="og:title" content="VideoView.md">
<meta property="og:url" content="http://example.com/2020/10/24/VideoView-md/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="项目需要做一个简单的播放视频功能demo,后期会换成公司自己的组件,所以就没考虑使用第三方库了,直接上系统的VideoView,在这里记录下操作;顺便吐槽下:一直都听说简书编辑器好用,第一次使用,有点失望,markdown跟效果分栏竟然不能同步滚动,也不支持[TOC],没有个目录实在很不习惯,表情图标也不能插入,代码区块加空行经常都识别不了啊,就不能让我简单滴从笔记中直接粘贴md文本吗… &#x3D;&#x3D;!">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2017/12/27/16096ad67f6d3007?w=994&h=606&f=png&s=44312">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2017/12/27/16096ad6ded691ba?w=462&h=273&f=gif&s=1162341">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2017/12/27/16096ad6e9b31984?w=356&h=645&f=gif&s=1471630">
<meta property="article:published_time" content="2020-10-24T02:39:51.000Z">
<meta property="article:modified_time" content="2020-10-24T02:41:14.372Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2017/12/27/16096ad67f6d3007?w=994&h=606&f=png&s=44312">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-VideoView-md" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/24/VideoView-md/" class="article-date">
  <time datetime="2020-10-24T02:39:51.000Z" itemprop="datePublished">2020-10-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      VideoView.md
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>项目需要做一个简单的播放视频功能demo,后期会换成公司自己的组件,所以就没考虑使用第三方库了,直接上系统的VideoView,在这里记录下操作;<br>顺便吐槽下:一直都听说简书编辑器好用,第一次使用,有点失望,markdown跟效果分栏竟然不能同步滚动,也不支持[TOC],没有个目录实在很不习惯,表情图标也不能插入,代码区块加空行经常都识别不了啊,就不能让我简单滴从笔记中直接粘贴md文本吗… ==!</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/lucid-lynxz/BlogSamples/tree/master/VideoViewDemo">Demo项目下载</a><br><a target="_blank" rel="noopener" href="https://github.com/lucid-lynxz/ZZVideoPlayer">自己封装了一个播放器</a></p>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><ol>
<li><a target="_blank" rel="noopener" href="http://itindex.net/detail/35521-android-%E6%92%AD%E6%94%BE-%E8%A7%86%E9%A2%91">Android三种播放视频的方式</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mikewootc.com/wiki/android/mid/mediaplayer_awesome.html">Android播放器框架分析之AwesomePlayer</a></li>
<li><a target="_blank" rel="noopener" href="http://www.bkjia.com/Androidjc/1110895.html">音频与视频播放</a> 讲的player类,比较全</li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/u010072711/article/details/51517170">Android视频播放器实现小窗口和全屏状态切换</a></li>
</ol>
<blockquote>
<p>视频播放原理:<br>系统会首先确定视频的格式，然后得到视频的编码..然后对编码进行解码，得到一帧一帧的图像，最后在画布上进行迅速更新,显然需要在独立的线程中完成,这时就需要使用surfaceView了</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://developer.android.com/intl/zh-cn/guide/appendix/media-formats.html#core">android 支持的编码格式</a><br><img src="https://user-gold-cdn.xitu.io/2017/12/27/16096ad67f6d3007?w=994&h=606&f=png&s=44312" alt="android_video_support_format.png"></p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">VideoView mVv = (VideoView) findViewById(R.id.vv);</span><br><span class="line"><span class="comment">//添加播放控制条,还是自定义好点</span></span><br><span class="line">mVv.setMediaController(<span class="keyword">new</span> MediaController(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置视频源播放res/raw中的文件,文件名小写字母,格式: 3gp,mp4等,flv的不一定支持;</span></span><br><span class="line">Uri rawUri = Uri.parse(<span class="string">&quot;android.resource://&quot;</span> + getPackageName() + <span class="string">&quot;/&quot;</span> + R.raw.shuai_dan_ge);</span><br><span class="line">mVv.setVideoURI(rawUri);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放在线视频</span></span><br><span class="line">mVideoUri = Uri.parse(<span class="string">&quot;http://****/abc.mp4&quot;</span>);</span><br><span class="line">mVv.setVideoPath(mVideoUri.toString());</span><br><span class="line"></span><br><span class="line">mVv.start();</span><br><span class="line">mVv.requestFocus();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">其他方法:</span></span><br><span class="line"><span class="comment">mVv.pause();</span></span><br><span class="line"><span class="comment">mVv.stop();</span></span><br><span class="line"><span class="comment">mVv.resume();</span></span><br><span class="line"><span class="comment">mVv.setOnPreparedListener(this);</span></span><br><span class="line"><span class="comment">mVv.setOnErrorListener(this);</span></span><br><span class="line"><span class="comment">mVv.setOnCompletionListener(this);**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Error信息处理 :</span></span><br><span class="line"><span class="comment">经常会碰到视频编码格式不支持的情况,这里还是处理一下,若不想弹出提示框就返回true;</span></span><br><span class="line"><span class="comment">http://developer.android.com/intl/zh-cn/reference/android/media/MediaPlayer.OnErrorListener.html</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">@Override </span></span><br><span class="line"><span class="comment">public boolean onError(MediaPlayer mp, int what, int extra) &#123; </span></span><br><span class="line"><span class="comment">   if(what==MediaPlayer.MEDIA_ERROR_SERVER_DIED)&#123; </span></span><br><span class="line"><span class="comment">        Log.v(TAG,&quot;Media Error,Server Died&quot;+extra); </span></span><br><span class="line"><span class="comment">   &#125;else if(what==MediaPlayer.MEDIA_ERROR_UNKNOWN)&#123; </span></span><br><span class="line"><span class="comment">        Log.v(TAG,&quot;Media Error,Error Unknown &quot;+extra); </span></span><br><span class="line"><span class="comment">   &#125; </span></span><br><span class="line"><span class="comment">return true; </span></span><br><span class="line"><span class="comment">&#125; </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h3><p><a target="_blank" rel="noopener" href="https://github.com/fallowu/slim_hardware_qcom_media/blob/master/QCMediaPlayer/com/qualcomm/qcmedia/QCMediaPlayer.java">QCMediaPlayer.java</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//常见错误: &quot;无法播放此视频&quot; -我测试的是:红米1s电信版4.4.4无法播放,但在三星s6（5.1.1）上就可以播放</span><br><span class="line">//播放源:http://27.152.191.198/c12.e.99.com/b/p/67/c4ff9f6535ac41a598bb05bf5b05b185/c4ff9f6535ac41a598bb05bf5b05b185.v.854.480.f4v</span><br><span class="line">MediaPlayer-JNI: QCMediaPlayer mediaplayer NOT present</span><br><span class="line">MediaPlayer: Unable to create media player</span><br><span class="line">MediaPlayer: Couldn&#x27;t open file on client side, trying server side</span><br><span class="line">MediaPlayer: error (1, -2147483648)</span><br><span class="line">MediaPlayer: Error (1,-2147483648)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/24501086/why-mediaplayer-throws-not-present-error-when-creating-instance-of-it">有人说</a> 用下面的方式可以处理该异常,但我是使用系统封装好的控件,这个操作不到吧? 先记录下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MediaPlayer player = MediaPlayer.create(<span class="keyword">this</span>, Uri.parse(sound_file_path));</span><br><span class="line">MediaPlayer player = MediaPlayer.create(<span class="keyword">this</span>, soundRedId, loop);</span><br></pre></td></tr></table></figure>

<h2 id="全屏播放-横竖屏切换"><a href="#全屏播放-横竖屏切换" class="headerlink" title="全屏播放 - 横竖屏切换"></a>全屏播放 - 横竖屏切换</h2><ul>
<li><p><code>androidmanifest.xml</code> 中依然还是定义竖屏,并定义一个切换横纵屏按钮 <code>btnChange</code> :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;lynxz.org.video.VideoActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:configChanges</span>=<span class="string">&quot;keyboard|orientation|screenSize&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.AppCompat.Light.NoActionBar&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>布局:需要在 <code>VidioView</code> 外层套一个容器,比如:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/rl_vv&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;200dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;@android:color/black&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:minHeight</span>=<span class="string">&quot;200dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:visibility</span>=<span class="string">&quot;visible&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">VideoView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/vv&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_centerInParent</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这么做是为了在切换屏幕方向的时候对 <code>rl_vv</code> 进行拉伸,而内部的 <code>VideoView</code> 会依据视频尺寸重新计算宽高,我们看看其 <code>onMeasure()</code> 源码就明了了,但若是直接具体指定了view的宽高,则视频会被拉伸:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//VideoView.java </span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> width = getDefaultSize(mVideoWidth, widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> height = getDefaultSize(mVideoHeight, heightMeasureSpec);</span><br><span class="line">    ......</span><br><span class="line">    setMeasuredDimension(width, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>按钮监听,手动切换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">btnSwitch.setOnClickListener(View -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (getRequestedOrientation() == ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE) &#123;</span><br><span class="line">        setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>设置VideoView布局尺寸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onConfigurationChanged(newConfig);</span><br><span class="line">    <span class="keyword">if</span> (mVv == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE)&#123;<span class="comment">//横屏</span></span><br><span class="line">        getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);</span><br><span class="line">        getWindow().getDecorView().invalidate();</span><br><span class="line">        <span class="keyword">float</span> height = DensityUtil.getWidthInPx(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">float</span> width = DensityUtil.getHeightInPx(<span class="keyword">this</span>);</span><br><span class="line">        mRlVv.getLayoutParams().height = (<span class="keyword">int</span>) width;</span><br><span class="line">        mRlVv.getLayoutParams().width = (<span class="keyword">int</span>) height;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowManager.LayoutParams attrs = getWindow().getAttributes();</span><br><span class="line">        attrs.flags &amp;= (~WindowManager.LayoutParams.FLAG_FULLSCREEN);</span><br><span class="line">        getWindow().setAttributes(attrs);</span><br><span class="line">        getWindow().clearFlags(WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS);</span><br><span class="line">        <span class="keyword">float</span> width = DensityUtil.getWidthInPx(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">float</span> height = DensityUtil.dip2px(<span class="keyword">this</span>, <span class="number">200.f</span>);</span><br><span class="line">        mRlVv.getLayoutParams().height = (<span class="keyword">int</span>) height;</span><br><span class="line">        mRlVv.getLayoutParams().width = (<span class="keyword">int</span>) width;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DensityUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> <span class="title">getHeightInPx</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">float</span> height = context.getResources().getDisplayMetrics().heightPixels;</span><br><span class="line">	<span class="keyword">return</span> height;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> <span class="title">getWidthInPx</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">float</span> width = context.getResources().getDisplayMetrics().widthPixels;</span><br><span class="line">	<span class="keyword">return</span> width;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外,如果是将播放器放于fragment中进行横竖屏切换,则需要在onCreateView中<code>setRetainInstance(true);</code>,这样旋转后,才不会重新创建从头开始播放;</p>
</li>
</ul>
<h2 id="获取第一帧的内容作为封面"><a href="#获取第一帧的内容作为封面" class="headerlink" title="获取第一帧的内容作为封面"></a>获取第一帧的内容作为封面</h2><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yydcdut/p/4222913.html">参考文章</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createVideoThumbnail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Observable&lt;Bitmap&gt; observable = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Bitmap&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Bitmap&gt; subscriber)</span> </span>&#123;</span><br><span class="line">            Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line">            MediaMetadataRetriever retriever = <span class="keyword">new</span> MediaMetadataRetriever();</span><br><span class="line">            <span class="keyword">int</span> kind = MediaStore.Video.Thumbnails.MINI_KIND;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">                retriever.setDataSource(mVideoUrl, <span class="keyword">new</span> HashMap&lt;String, String&gt;());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retriever.setDataSource(mVideoUrl);</span><br><span class="line">            &#125;</span><br><span class="line">            bitmap = retriever.getFrameAtTime();</span><br><span class="line">            subscriber.onNext(bitmap);</span><br><span class="line">            retriever.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">observable.observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">        .subscribeOn(Schedulers.io())</span><br><span class="line">        .subscribe(<span class="keyword">new</span> Action1&lt;Bitmap&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//设置封面</span></span><br><span class="line">                mYourVideoPlayerContainer.setBackgroundDrawable(<span class="keyword">new</span> BitmapDrawable(bitmap));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="滑动改变屏幕亮度-音量"><a href="#滑动改变屏幕亮度-音量" class="headerlink" title="滑动改变屏幕亮度/音量"></a>滑动改变屏幕亮度/音量</h2><ul>
<li><p>权限申请</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_SETTINGS&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.VIBRATE&quot;</span>/&gt;</span> //按需申请</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改亮度方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*设置当前屏幕亮度值 0--255，并使之生效*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setScreenBrightness</span><span class="params">(<span class="keyword">float</span> value)</span> </span>&#123;</span><br><span class="line">    WindowManager.LayoutParams lp = getWindow().getAttributes();</span><br><span class="line">    lp.screenBrightness = lp.screenBrightness + value / <span class="number">255.0f</span>;</span><br><span class="line">    Vibrator vibrator;</span><br><span class="line">    <span class="keyword">if</span> (lp.screenBrightness &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        lp.screenBrightness = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//              vibrator = (Vibrator) getSystemService(VIBRATOR_SERVICE);</span></span><br><span class="line">        <span class="comment">//              long[] pattern = &#123;10, 200&#125;; // OFF/ON/OFF/ON...</span></span><br><span class="line">        <span class="comment">//              vibrator.vibrate(pattern, -1);</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lp.screenBrightness &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">        lp.screenBrightness = (<span class="keyword">float</span>) <span class="number">0.2</span>;</span><br><span class="line">        <span class="comment">//              vibrator = (Vibrator) getSystemService(VIBRATOR_SERVICE);</span></span><br><span class="line">        <span class="comment">//              long[] pattern = &#123;10, 200&#125;; // OFF/ON/OFF/ON...</span></span><br><span class="line">        <span class="comment">//              vibrator.vibrate(pattern, -1);</span></span><br><span class="line">    &#125;</span><br><span class="line">    getWindow().setAttributes(lp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存设置的屏幕亮度值</span></span><br><span class="line">    <span class="comment">// Settings.System.putInt(getContentResolver(), Settings.System.SCREEN_BRIGHTNESS, (int) value);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置屏幕亮度模式方法 (自动/手动)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// value 可取值: Settings.System.SCREEN_BRIGHTNESS_MODE_AUTOMATIC / SCREEN_BRIGHTNESS_MODE_MANUAL</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setScreenMode</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">    Settings.System.putInt(getContentResolver(), Settings.System.SCREEN_BRIGHTNESS_MODE, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>监听播放区域</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mGestureDetector = <span class="keyword">new</span> GestureDetector(<span class="keyword">this</span>, mGestureListener);</span><br><span class="line">vv.setOnTouchListener(<span class="keyword">this</span>); </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mGestureDetector.onTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>onScroll的时候动态改变亮度<br><code>onDown()</code> / <code>onScroll()</code> 返回true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> android.view.GestureDetector.OnGestureListener mGestureListener = <span class="keyword">new</span> GestureDetector.OnGestureListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDown</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShowPress</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSingleTapUp</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onScroll</span><span class="params">(MotionEvent e1, MotionEvent e2, <span class="keyword">float</span> distanceX, <span class="keyword">float</span> distanceY)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">double</span> FLING_MIN_VELOCITY = <span class="number">0.5</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">double</span> FLING_MIN_DISTANCE = <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e1.getY() - e2.getY() &gt; FLING_MIN_DISTANCE</span><br><span class="line">                &amp;&amp; Math.abs(distanceY) &gt; FLING_MIN_VELOCITY) &#123;</span><br><span class="line">            setScreenBrightness(<span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (e1.getY() - e2.getY() &lt; FLING_MIN_DISTANCE</span><br><span class="line">                &amp;&amp; Math.abs(distanceY) &gt; FLING_MIN_VELOCITY) &#123;</span><br><span class="line">            setScreenBrightness(-<span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLongPress</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onFling</span><span class="params">(MotionEvent e1, MotionEvent e2, <span class="keyword">float</span> velocityX, <span class="keyword">float</span> velocityY)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="滑动修改音量"><a href="#滑动修改音量" class="headerlink" title="滑动修改音量"></a>滑动修改音量</h3><p>修改上方的 <code>onScroll()</code> 方法,调用以下操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setVoiceVolume</span><span class="params">(<span class="keyword">boolean</span> volumeUp)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  设置音量绝对值的话,我在小米上突破不了限制,最大音量15,但是设置到10的时候就没法再增加了,最后使用系统的音量控制才可以</span></span><br><span class="line">    <span class="comment">//        int currentVolume = mAudioManager.getStreamVolume(AudioManager.STREAM_MUSIC);</span></span><br><span class="line">    <span class="comment">//        int maxVolume = mAudioManager.getStreamMaxVolume(AudioManager.STREAM_MUSIC);</span></span><br><span class="line">    <span class="comment">//        int flag = volumeUp ? 1 : -1;</span></span><br><span class="line">    <span class="comment">//        currentVolume += flag * 1;</span></span><br><span class="line">    <span class="comment">//        if (currentVolume &gt;= maxVolume) &#123;</span></span><br><span class="line">    <span class="comment">//            currentVolume = maxVolume;</span></span><br><span class="line">    <span class="comment">//        &#125; else if (currentVolume &lt;= 1) &#123;</span></span><br><span class="line">    <span class="comment">//            currentVolume = 1;</span></span><br><span class="line">    <span class="comment">//        &#125;</span></span><br><span class="line">    <span class="comment">//        Log.i(TAG, &quot;setVoiceVolume currentVolume = &quot; + currentVolume + &quot; ,maxVolume = &quot; + maxVolume);</span></span><br><span class="line">    <span class="comment">//        mAudioManager.setStreamVolume(AudioManager.STREAM_MUSIC, currentVolume, 0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//降低音量，调出系统音量控制</span></span><br><span class="line">    <span class="keyword">if</span> (volumeUp) &#123;</span><br><span class="line">        mAudioManager.adjustStreamVolume(AudioManager.STREAM_MUSIC, AudioManager.ADJUST_RAISE,</span><br><span class="line">                AudioManager.FX_FOCUS_NAVIGATION_UP);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//增加音量，调出系统音量控制</span></span><br><span class="line">        mAudioManager.adjustStreamVolume(AudioManager.STREAM_MUSIC, AudioManager.ADJUST_LOWER,</span><br><span class="line">                AudioManager.FX_FOCUS_NAVIGATION_UP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在页面关闭时可考虑恢复亮度/音量初始值</li>
<li>在onTouch的时候对触点进行判断,区分是修改音量或是改变亮度</li>
</ul>
<h2 id="需要处理的问题"><a href="#需要处理的问题" class="headerlink" title="需要处理的问题"></a>需要处理的问题</h2><h3 id="拖动进度条-手动seekTo后-进度会跳动"><a href="#拖动进度条-手动seekTo后-进度会跳动" class="headerlink" title="拖动进度条,手动seekTo后,进度会跳动"></a>拖动进度条,手动seekTo后,进度会跳动</h3><p>断点跟踪后发现是native方法的问题,各大视频播放平台的客户端,比较普遍存在,暂无法处理:<br><img src="https://user-gold-cdn.xitu.io/2017/12/27/16096ad6ded691ba?w=462&h=273&f=gif&s=1162341" alt="优酷客户端时间跳变"></p>
<p>找到些资源:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/f51b2febcfd2">关于Android VideoView seekTo不准确的解决方案</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/qingyuanluofeng/article/details/45375647">视频关键帧提取</a><br>第一个提到的关键帧问题,我找了个视频测试了下,seekTo到固定的时间点,则跳变的位置也固定;</li>
</ol>
<h3 id="暂停-恢复-页面时-视频重新加载"><a href="#暂停-恢复-页面时-视频重新加载" class="headerlink" title="暂停/恢复 页面时,视频重新加载"></a>暂停/恢复 页面时,视频重新加载</h3><p>现象: 在视频播放时,使页面 <code>onPause()</code> ,之后再恢复,则 <code>videoView</code> 会重新开始播放,临时的处理方案是在 <code>onPause()</code> 的时候记录当前播放进度位置,在 <code>onResume()</code> 的时候拖动到该进度位置,但是该方案仍会有黑屏现象,代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> mPlayingPos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mPlayingPos = mVideoView.getCurrentPosition(); <span class="comment">//先获取再stopPlay(),原因自己看源码</span></span><br><span class="line">    mVideoView.stopPlayback();</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPlayingPos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//此处为更好的用户体验,可添加一个progressBar,有些客户端会在这个过程中隐藏底下控制栏,这方法也不错</span></span><br><span class="line">        mVideoView.start();</span><br><span class="line">        mVideoView.seekTo(mPlayingPos);</span><br><span class="line">        mPlayingPos = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到些可能相关的文章,链接已失效,快照如下(还得去看看 <code>surfaceView</code> 啊 ~ ~# ):<br>另一篇类似的: <a target="_blank" rel="noopener" href="http://www.boyunjian.com/do/article/snapshot.do?uid=3453185252600635258">android开发常见问题</a> 问题7,也指明是 <code>surfaceview</code> 的原因,之所以是黑色的见后面的解释:</p>
<blockquote>
<p>Activity 调用的顺序是 onPause() -&gt; onStop()<br>SurfaceView 调用了 surfaceDestroyed() 方法<br>然后再切回程序<br>Activity 调用的顺序是 onRestart() -&gt; onStart() -&gt; onResume ()<br>SurfaceView` 调用了 surfaceChanged() -&gt; surfaceCreated() 方法<br>按挂断键或锁定屏幕<br>Activity 只调用 onPause() 方法<br>解锁后 Activity 调用 onResume() 方法<br>SurfaceView 什么方法都不调用 </p>
</blockquote>
<h3 id="网络变化-切换应用后恢复播放"><a href="#网络变化-切换应用后恢复播放" class="headerlink" title="网络变化/切换应用后恢复播放"></a>网络变化/切换应用后恢复播放</h3><p>播放过程中,假如只缓冲了一部分视频,则当播放完缓冲部分后,会抛出1004异常,即使此时网络连接已经恢复,控件也不会自动继续缓冲:<br><code>MediaPlayer: error (1, -1004)</code><br>源码注释: <code>File or network related operation errors</code><br>同时,由于SurfaceView在页面onStop()时会destroy,比如播放时,用户按下home键或切换到其他应用页面再返回时,视频播放停止,此时需要重新加载视频并播放到上次停止的位置;</p>
<p>另外,有测试发现在三星G9200手机上,报 <code>1004</code> 这个错的时候会弹出错误提示框,然后卡死重启…<br>对比了下日志:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// API23 MediaPlayer.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mMediaPlayer.mNativeContext == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">&quot;mediaplayer went away with unhandled events&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span>(msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> MEDIA_ERROR:</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;Error (&quot;</span> + msg.arg1 + <span class="string">&quot;,&quot;</span> + msg.arg2 + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> error_was_handled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mOnErrorListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            error_was_handled = mOnErrorListener.onError(mMediaPlayer, msg.arg1, msg.arg2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mOnCompletionListener != <span class="keyword">null</span> &amp;&amp; ! error_was_handled) &#123;</span><br><span class="line">            mOnCompletionListener.onCompletion(mMediaPlayer);</span><br><span class="line">        &#125;</span><br><span class="line">        stayAwake(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;Unknown message type &quot;</span> + msg.what);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//API23 VideoView.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnErrorListener</span><span class="params">(OnErrorListener l)</span></span>&#123;</span><br><span class="line">    mOnErrorListener = l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MediaPlayer.OnErrorListener mErrorListener =</span><br><span class="line">    <span class="keyword">new</span> MediaPlayer.OnErrorListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onError</span><span class="params">(MediaPlayer mp, <span class="keyword">int</span> framework_err, <span class="keyword">int</span> impl_err)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If an error handler has been supplied, use it and finish. */</span></span><br><span class="line">        <span class="keyword">if</span> (mOnErrorListener != <span class="keyword">null</span>) &#123; <span class="comment">//如果这里没有处理,则每次发生异常都会弹出提示框,可能造成崩溃</span></span><br><span class="line">            <span class="keyword">if</span> (mOnErrorListener.onError(mMediaPlayer, framework_err, impl_err)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Otherwise, pop up an error dialog so the user knows that</span></span><br><span class="line"><span class="comment">            * something bad has happened. Only try and pop up the dialog</span></span><br><span class="line"><span class="comment">            * if we&#x27;re attached to a window. When we&#x27;re going away and no</span></span><br><span class="line"><span class="comment">            * longer have a window, don&#x27;t bother showing the user an error.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        <span class="keyword">if</span> (getWindowToken() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Resources r = mContext.getResources();</span><br><span class="line">            <span class="keyword">int</span> messageId;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (framework_err == MediaPlayer.MEDIA_ERROR_NOT_VALID_FOR_PROGRESSIVE_PLAYBACK) &#123;</span><br><span class="line">                messageId = com.android.internal.R.string.VideoView_error_text_invalid_progressive_playback;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                messageId = com.android.internal.R.string.VideoView_error_text_unknown;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 弹出错误提示框</span></span><br><span class="line">            <span class="keyword">new</span> AlertDialog.Builder(mContext)</span><br><span class="line">                    .setMessage(messageId)</span><br><span class="line">                    .setPositiveButton(com.android.internal.R.string.VideoView_error_button,</span><br><span class="line">                            <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> whichButton)</span> </span>&#123;</span><br><span class="line">                                    <span class="comment">/* If we get here, there is no onError listener, so</span></span><br><span class="line"><span class="comment">                                        * at least inform them that the video is over.</span></span><br><span class="line"><span class="comment">                                        */</span></span><br><span class="line">                                    <span class="keyword">if</span> (mOnCompletionListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                        mOnCompletionListener.onCompletion(mMediaPlayer);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;)</span><br><span class="line">                    .setCancelable(<span class="keyword">false</span>)</span><br><span class="line">                    .show();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因此需要对网络变化进行监听:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    mNetworkState = NetworkHelper.getNetworkType(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//播放网络视频时,需要检测判断网络状态变化</span></span><br><span class="line">    <span class="keyword">if</span> (SCHEME_HTTP.equalsIgnoreCase(mVideoUri.getScheme()) &amp;&amp; mNetworkState == <span class="number">0</span>) &#123;</span><br><span class="line">        MessageUtils.showAlertDialog(<span class="keyword">this</span>, <span class="string">&quot;提示&quot;</span>, getResources().getString(R.string.network_error), <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPlayingPos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mVv.start();</span><br><span class="line">            mVv.seekTo(mPlayingPos);</span><br><span class="line">            mPlayingPos = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听网络变化,用于重新缓冲</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerNetworkReceiver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNetworkReceiver == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mNetworkReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">                String action = intent.getAction();</span><br><span class="line">                <span class="keyword">if</span> (SCHEME_HTTP.equalsIgnoreCase(mVideoUri.getScheme())</span><br><span class="line">                            &amp;&amp; action.equalsIgnoreCase(ConnectivityManager.CONNECTIVITY_ACTION)) &#123;</span><br><span class="line">                    doWhenNetworkChange();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    registerReceiver(mNetworkReceiver, <span class="keyword">new</span> IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 网络播放</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWhenNetworkChange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mNetworkState = NetworkHelper.getNetworkType(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//保存当前已缓存长度</span></span><br><span class="line">    <span class="keyword">int</span> bufferPercentage = mVv.getBufferPercentage();</span><br><span class="line">    mLastLoadLength = bufferPercentage * mVv.getDuration() / <span class="number">100</span>;</span><br><span class="line">    <span class="comment">//这里需要判断 0</span></span><br><span class="line">    <span class="keyword">int</span> currentPosition = mVv.getCurrentPosition();</span><br><span class="line">    <span class="keyword">if</span> (currentPosition &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mPlayingPos = currentPosition;</span><br><span class="line">    &#125;</span><br><span class="line">    debugLog(bufferPercentage + <span class="string">&quot; 网络变化 ... &quot;</span> + mNetworkState + <span class="string">&quot; 缓存长度 &quot;</span> + mLastLoadLength + <span class="string">&quot; -- &quot;</span> + currentPosition);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mNetworkState == NetworkHelper.NETWORK_TYPE_INVALID &amp;&amp; bufferPercentage &lt; <span class="number">100</span>) &#123;</span><br><span class="line">        <span class="comment">// 监听当前播放位置,在达到缓冲长度前自动停止</span></span><br><span class="line">        <span class="keyword">if</span> (mCheckPlayingProgressTimer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mCheckPlayingProgressTimer = <span class="keyword">new</span> Timer();</span><br><span class="line">        &#125;</span><br><span class="line">        mCheckPlayingProgressTimer.schedule(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (mPlayingPos &gt;= mLastLoadLength - deltaTime) &#123;</span><br><span class="line">                    mVv.pause();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, <span class="number">1000</span>);<span class="comment">//每秒检测一次</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        restartPlayVideo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">restartPlayVideo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//todo 添加 progressBar 体验好点</span></span><br><span class="line">    <span class="keyword">if</span> (mCheckPlayingProgressTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mCheckPlayingProgressTimer.cancel();</span><br><span class="line">        mCheckPlayingProgressTimer = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mVv.setVideoURI(mVideoUri);</span><br><span class="line">    mVv.start();</span><br><span class="line">    mVv.seekTo(mPlayingPos);</span><br><span class="line"></span><br><span class="line">    mLastLoadLength = -<span class="number">1</span>;</span><br><span class="line">    mPlayingPos = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mPlayingPos = mVv.getCurrentPosition();</span><br><span class="line">    mVv.pause();</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mVv.stopPlayback();</span><br><span class="line">    mLastLoadLength = <span class="number">0</span>;</span><br><span class="line">    debugLog(<span class="string">&quot;onResume &quot;</span> + mPlayingPos + <span class="string">&quot; -- &quot;</span> + mLastLoadLength);</span><br><span class="line">    <span class="keyword">super</span>.onStop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (mCheckPlayingProgressTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mCheckPlayingProgressTimer.cancel();</span><br><span class="line">        mCheckPlayingProgressTimer = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    unregisterNetworkReceiver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h3 id="seekbar变化超出缓冲长度"><a href="#seekbar变化超出缓冲长度" class="headerlink" title="seekbar变化超出缓冲长度"></a>seekbar变化超出缓冲长度</h3><p>使用系统提供的控件 <code>mVv.setMediaController(new MediaController(this));</code> 的话,在断网时,仍可以拖动超出缓冲长度的范围,会报错,这个还是得自定义才能控制可拖动位置,不再赘述;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MediaPlayer: Attempt to perform seekTo in wrong state: mPlayer=0x7f7ebbf5c0, mCurrentState=0</span><br><span class="line">MediaPlayer: Error (1,-1004)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//API 23 MediaController.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnSeekBarChangeListener mSeekListener = <span class="keyword">new</span> OnSeekBarChangeListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProgressChanged</span><span class="params">(SeekBar bar, <span class="keyword">int</span> progress, <span class="keyword">boolean</span> fromuser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!fromuser) &#123;</span><br><span class="line">            <span class="comment">// We&#x27;re not interested in programmatically generated changes to</span></span><br><span class="line">            <span class="comment">// the progress bar&#x27;s position.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里就只是设定mediaplayer的播放位置而已</span></span><br><span class="line">        <span class="keyword">long</span> duration = mPlayer.getDuration();</span><br><span class="line">        <span class="keyword">long</span> newposition = (duration * progress) / <span class="number">1000L</span>;</span><br><span class="line">        mPlayer.seekTo( (<span class="keyword">int</span>) newposition);</span><br><span class="line">        <span class="keyword">if</span> (mCurrentTime != <span class="keyword">null</span>)</span><br><span class="line">            mCurrentTime.setText(stringForTime( (<span class="keyword">int</span>) newposition));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当断网后,用户拖动超出缓冲区长度的话mediaplayer报错,此时再次点击VideoView区域,不会触发显示控制条,真是各种不方便啊,还是建议自己写一个控制条;</p>
<h1 id="SurfaceView"><a href="#SurfaceView" class="headerlink" title="SurfaceView"></a>SurfaceView</h1><h2 id="资源-1"><a href="#资源-1" class="headerlink" title="资源"></a>资源</h2><ol>
<li><a target="_blank" rel="noopener" href="http://tech.youzan.com/surfaceview-sourcecode/">SurfaceView 源码分析及使用</a><br>这篇讲到了 <code>SurfaceView</code> 会显示黑色区域的原因:<blockquote>
<p>SurfaceView 的 draw 和 dispatchDraw 方法中看到，SurfaceView 中，windownType变量被初始化为WindowManager.LayoutParams.TYPE_APPLICATION_MEDIA，所以在创建绘制这个 View 的过程中整个 Canvas 会被涂成黑色</p>
</blockquote>
</li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/Hello__Zero/article/details/42389197">浮层视频效果,在另外一个Window使用SurfaceView无法正常显示的问题排查与解决</a></li>
</ol>
<h2 id="surfaceView黑屏"><a href="#surfaceView黑屏" class="headerlink" title="surfaceView黑屏"></a>surfaceView黑屏</h2><ol>
<li><p>无内容时,默认会绘制黑色背景图</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SurfaceView.java</span></span><br><span class="line"><span class="keyword">int</span> mWindowType = WindowManager.LayoutParams.TYPE_APPLICATION_MEDIA;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWindowType != WindowManager.LayoutParams.TYPE_APPLICATION_PANEL) &#123;</span><br><span class="line">        <span class="comment">// draw() is not called when SKIP_DRAW is set</span></span><br><span class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SKIP_DRAW) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// punch a whole in the view-hierarchy below us</span></span><br><span class="line">            canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.draw(canvas);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>感谢<a target="_blank" rel="noopener" href="http://www.jianshu.com/users/ce0ae357d9bb">@尚弟很忙哒</a> 的提醒, 设置页面主题为透明(<code>android:theme=&quot;@android:style/Theme.Translucent&quot;</code>)时,在初始缓冲阶段,VideoView区域会变成透明:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;org.lynxz.androiddemos.VideoViewActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;200dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">&quot;@android:color/holo_blue_bright&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">VideoView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/vv&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_centerInParent</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在SurfaceView类开头有酱紫的一段注释,大概能解释为什么缓冲时候视频区域会透明了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The surface is Z ordered so that it is behind the window holding its SurfaceView; </span><br><span class="line">the SurfaceView punches a hole in its window to allow its surface to be displayed.</span><br></pre></td></tr></table></figure>
<p>因此处理方案就变成将SurfaceView挪到上层即可:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mVv.setZOrderOnTop(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>不过挪动之后就可以设置VideoView的背景,此时才不会遮盖实际的视频绘图了,xml中指定吧,这里省略,不过如果VideoView区域还有其他控件的话,会被遮盖,所以最后我就没设定zorderOnTop了,而是直接在xml中指定VideoView的背景色,然后在onPrepare回调的时候,去掉背景即可(按需延时,或者在有播放进度,要更新进度条的时候进行去掉背景操作都ok,不然可能会有一瞬间的透明):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mVv.setBackgroundColor(Color.TRANSPARENT);</span><br></pre></td></tr></table></figure>
<p>之前是打算像网上说的给VideoView的holder添加一个callback,(<code>mVv.getHolder().addCallback(new SurfaceHolder.Callback() &#123;...&#125;</code>) ,在 <code>surfaceCreated()</code> 的时候获取canvas并手动绘制背景色,但是 <code>holder.lockCanvas()</code> 一直返回 <code>null</code> ,log信息提示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">E&#x2F;SurfaceHolder: Exception locking surface</span><br><span class="line">                           java.lang.IllegalArgumentException</span><br><span class="line">                           at android.view.Surface.nativeLockCanvas(Native Method)</span><br><span class="line">                            .......</span><br></pre></td></tr></table></figure>
<p>看到native我暂时就没招了,打住,老实用变通方法吧;</p>
</li>
<li><p>手机 “菜单键” 导致应用被stop,虽然此时看起来可见<br><code>SurfaceView.java</code>   的注释: 在调用菜单键的时候虽然页面貌似可见,但实际已经调用了onStop()方法了,而surface在window不可见时会销毁:</p>
<blockquote>
<p>The Surface will be created for you while the SurfaceView’s window is<br>visible; you should implement {@link SurfaceHolder.Callback#surfaceCreated}<br>and {@link SurfaceHolder.Callback#surfaceDestroyed} to discover when the<br>Surface is created and destroyed as the window is shown and hidden.</p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/27/16096ad6e9b31984?w=356&h=645&f=gif&s=1471630" alt=" 按下菜单键后返回"></p>
</li>
<li><p>VideoView无法播放f4v格式(三星s6可以播放,红米1s(4.4.4)播放失败)….<br>以后能力够了可以参考下这篇 :     </p>
<ul>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/bonderwu/article/details/6261798">Android平台Stagefright中增加flv/f4v支持及相关原理介绍</a></li>
<li><a target="_blank" rel="noopener" href="http://www.iaeej.com/xxydzgc/ch/reader/create_pdf.aspx?file_no=20130512&year_id=2013&quarter_id=5&falg=1">Stagefright功能扩展</a> 这篇论文前半部分有关于多媒体框架调用的介绍</li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/10/24/VideoView-md/" data-id="ckgn2xkfy0002qxwd7vpp2g17" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/10/24/LifeCycle%E8%A7%A3%E6%9E%90-md/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          LifeCycle解析.md
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/24/%E5%BA%94%E8%AF%A5%E4%BB%8EAPI15%E8%BF%98%E6%98%AF14%E5%BC%80%E5%A7%8B%E6%94%AF%E6%8C%81-md/">应该从API15还是14开始支持.md</a>
          </li>
        
          <li>
            <a href="/2020/10/24/LifeCycle%E8%A7%A3%E6%9E%90-md/">LifeCycle解析.md</a>
          </li>
        
          <li>
            <a href="/2020/10/24/VideoView-md/">VideoView.md</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>